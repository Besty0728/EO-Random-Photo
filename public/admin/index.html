<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºå›¾åºŠç®¡ç†åå°</title>
    <style>
        :root {
            --primary-color: #006eff;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #1a202c;
            --border-color: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 2rem;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        .status-kv {
            background-color: #def7ec;
            color: #03543f;
        }

        .status-env {
            background-color: #fefcbf;
            color: #744210;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-input {
            display: none;
        }

        .toggle-label {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
            background-color: #cbd5e0;
            border-radius: 9999px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .toggle-label::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-input:checked+.toggle-label {
            background-color: var(--primary-color);
        }

        .toggle-input:checked+.toggle-label::after {
            transform: translateX(24px);
        }

        button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #cbd5e0;
            cursor: not-allowed;
        }

        #login-screen {
            display: flex;
            /* Initially hidden conditionally via JS, but we'll manage with classes */
        }

        .hidden {
            display: none !important;
        }

        .error-msg {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Login Screen -->
        <div id="login-screen" class="card">
            <h1>ç®¡ç†å‘˜ç™»å½•</h1>
            <div class="form-group">
                <input type="password" id="password-input" placeholder="è¯·è¾“å…¥ ADMIN_PASSWORD"
                    onkeydown="if(event.key==='Enter') login()">
            </div>
            <button onclick="login()">ç™»å½•</button>
            <p id="login-error" class="error-msg hidden">å¯†ç é”™è¯¯æˆ–è¿æ¥å¤±è´¥</p>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="card hidden">
            <h1>å›¾åºŠé…ç½®</h1>
            <div id="status-badge" class="status-badge status-env">
                æ£€æµ‹é…ç½®æ¨¡å¼...
            </div>

            <div class="form-group toggle-switch">
                <label for="ddos-mode">ğŸ›¡ï¸ DDoS é˜²å¾¡æ¨¡å¼ (Micro-caching)</label>
                <div>
                    <input type="checkbox" id="ddos-mode" class="toggle-input">
                    <label for="ddos-mode" class="toggle-label"></label>
                </div>
            </div>

            <div class="form-group">
                <label for="cache-timeout">DDoS ç¼“å­˜æ—¶é—´ (ç§’): <span id="cache-timeout-val">5</span></label>
                <input type="range" id="cache-timeout" min="1" max="60" value="5">
            </div>

            <div class="form-group toggle-switch">
                <label for="public-access">å…¬å¼€è®¿é—® (Public Mode)</label>
                <div>
                    <input type="checkbox" id="public-access" class="toggle-input">
                    <label for="public-access" class="toggle-label"></label>
                </div>
            </div>

            <div class="form-group">
                <label for="whitelist">Referer ç™½åå• (é€—å·åˆ†éš”)</label>
                <textarea id="whitelist" placeholder="example.com, myblog.com" style="height: 60px;"></textarea>
            </div>

            <div class="form-group">
                <label for="public-images">å…¬å¼€å›¾ç‰‡ç™½åå• (æ–‡ä»¶å, é€—å·åˆ†éš”)</label>
                <textarea id="public-images" placeholder="banner.jpg, welcome.png" style="height: 60px;"></textarea>
                <small style="color: #718096; font-size: 0.8rem;">åœ¨æ­¤åˆ—è¡¨ä¸­çš„å›¾ç‰‡å¯ä»¥è¢«ä»»ä½•ç½‘ç«™ç›´æ¥å¼•ç”¨ (ç»•è¿‡é˜²ç›—é“¾)</small>
            </div>

            <button id="save-btn" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            <p id="save-msg" class="error-msg hidden" style="color: green; margin-top: 10px;">ä¿å­˜æˆåŠŸ!</p>
        </div>
    </div>

    <script>
        let authToken = '';

        async function login() {
            const password = document.getElementById('password-input').value;
            if (!password) return;

            // Try to fetch config to verify password
            try {
                const res = await fetch('/api/admin', {
                    headers: { 'Authorization': 'Bearer ' + password }
                });

                if (res.status === 200) {
                    authToken = password;
                    const config = await res.json();
                    showDashboard(config);
                } else {
                    showError('å¯†ç é”™è¯¯ (Status: ' + res.status + ')');
                }
            } catch (e) {
                showError('è¿æ¥å¤±è´¥: ' + e.message);
            }
        }

        function showError(msg) {
            const el = document.getElementById('login-error');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function showDashboard(config) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            const isKV = config.source === 'KV';
            const statusEl = document.getElementById('status-badge');
            const saveBtn = document.getElementById('save-btn');
            const inputs = [
                document.getElementById('public-access'),
                document.getElementById('whitelist'),
                document.getElementById('ddos-mode'),
                document.getElementById('cache-timeout'),
                document.getElementById('public-images')
            ];

            if (isKV) {
                statusEl.textContent = 'å½“å‰æ¨¡å¼: KV Storage (å¯è¯»å†™)';
                statusEl.className = 'status-badge status-kv';
                saveBtn.disabled = false;
                inputs.forEach(el => el.disabled = false);
            } else {
                statusEl.textContent = 'å½“å‰æ¨¡å¼: ç¯å¢ƒå˜é‡ (åªè¯»)';
                statusEl.className = 'status-badge status-env';
                saveBtn.textContent = 'åªè¯»æ¨¡å¼ (æ— æ³•ä¿®æ”¹)';
                saveBtn.disabled = true;
                inputs.forEach(el => el.disabled = true);
            }

            // Populate Form
            document.getElementById('public-access').checked = config.publicAccess;
            document.getElementById('whitelist').value = config.whitelist.join(', ');
            document.getElementById('ddos-mode').checked = config.ddosMode;
            document.getElementById('cache-timeout').value = config.ddosCacheTimeout;
            document.getElementById('cache-timeout-val').textContent = config.ddosCacheTimeout;
            document.getElementById('public-images').value = config.publicImages.join(', ');

            // Slider listener
            document.getElementById('cache-timeout').addEventListener('input', (e) => {
                document.getElementById('cache-timeout-val').textContent = e.target.value;
            });
        }

        async function saveConfig() {
            const publicAccess = document.getElementById('public-access').checked;
            const whitelistStr = document.getElementById('whitelist').value;
            const whitelist = whitelistStr.split(',').map(s => s.trim()).filter(s => s);
            const ddosMode = document.getElementById('ddos-mode').checked;
            const ddosCacheTimeout = parseInt(document.getElementById('cache-timeout').value, 10);

            const publicImagesStr = document.getElementById('public-images').value;
            const publicImages = publicImagesStr.split(',').map(s => s.trim()).filter(s => s);

            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';

            try {
                const res = await fetch('/api/admin', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ publicAccess, whitelist, ddosMode, ddosCacheTimeout, publicImages })
                });

                if (res.ok) {
                    const msg = document.getElementById('save-msg');
                    msg.classList.remove('hidden');
                    msg.textContent = 'ä¿å­˜æˆåŠŸ!';
                    setTimeout(() => msg.classList.add('hidden'), 3000);
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + await res.text());
                }
            } catch (e) {
                alert('ä¿å­˜é”™è¯¯: ' + e.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜é…ç½®';
            }
        }
    </script>
</body>

</html>